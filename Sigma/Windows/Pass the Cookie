title: Azure Atypical Sign-in Chain with Mimikatz Execution
id: 9a8b7c6d-5e4f-3a2b-1c0d-9e8f7a6b5c4d
status: experimental
description: Detects suspicious Azure AD sign-in chain followed by Mimikatz credential dumping on Windows endpoints - indicates account compromise leading to lateral movement and credential theft
author: Ralph
date: 2026/02/13
references:
    - https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/concept-identity-protection-risks
    - https://attack.mitre.org/techniques/T1078/004/
    - https://attack.mitre.org/techniques/T1003/001/
    - https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment
    - https://tools.thehacker.recipes/mimikatz/modules
logsource:
    # Multi-source correlation required (Azure SignInLogs + Windows Process Creation)
    # Step 1-5: Azure AD SignInLogs
    # Step 6: Windows Sysmon/Security Event Logs
    product:
        - azure
        - windows
    service:
        - signinlogs
        - security
    category: process_creation
detection:
    # Step 1: Atypical travel detected (impossible travel or suspicious location change)
    step1:
        Category: 'SignInLogs'
        ResultType: 0  # Successful sign-in
        RiskEventTypes|contains:
            - 'impossibleTravel'
            - 'unfamiliarFeatures'
            - 'unlikelyTravel'

    # Step 2: Anonymous IP address or Tor network usage
    step2:
        Category: 'SignInLogs'
        ResultType: 0
        RiskEventTypes|contains:
            - 'anonymizedIPAddress'
            - 'anonymousIPAddress'
            - 'maliciousIPAddress'

    # Step 3: Risky sign-in behavior (no MFA, new device, or unusual user agent)
    step3:
        Category: 'SignInLogs'
        ResultType: 0
        AuthenticationRequirement: 'singleFactorAuthentication'  # No MFA used

    # Step 4: Multiple failed attempts followed by success (potential credential stuffing)
    step4:
        Category: 'SignInLogs'
        ResultType:
            - 50126  # Invalid username or password
            - 50053  # Account locked
            - 50057  # Account disabled

    # Step 5: Successful sign-in after suspicious chain
    step5:
        Category: 'SignInLogs'
        ResultType: 0  # Success
        RiskState:
            - 'atRisk'
            - 'confirmedCompromised'

    # ===== STEP 6: MIMIKATZ CREDENTIAL DUMPING (Windows Endpoint) =====
    # Post-compromise activity: Mimikatz execution after suspicious Azure sign-in
    # Uses process_creation category (Sysmon EventID 1 / Security EventID 4688)

    step6_mimikatz_tools:
        CommandLine|contains:
            - 'DumpCreds'
            - 'mimikatz'

    step6_mimikatz_functions:
        CommandLine|contains:
            - '::aadcookie'   # Azure AD cookie extraction
            - '::detours'     # API hooking
            - '::memssp'      # Memory SSP
            - '::mflt'        # Minifilter
            - '::ncroutemon'  # Network routing
            - '::ngcsign'     # NGC signing
            - '::printnightmare'  # PrintNightmare exploit
            - '::skeleton'    # Skeleton key
            - '::preshutdown' # Service module
            - '::mstsc'       # RDP manipulation
            - '::multirdp'    # Multiple RDP sessions

    step6_mimikatz_modules:
        CommandLine|contains:
            - 'rpc::'        # RPC control
            - 'token::'      # Token manipulation
            - 'crypto::'     # Cryptographic functions
            - 'dpapi::'      # Data Protection API
            - 'sekurlsa::'   # LSASS memory dumping
            - 'kerberos::'   # Kerberos ticket manipulation
            - 'lsadump::'    # LSA secrets dumping
            - 'privilege::'  # Privilege escalation
            - 'process::'    # Process manipulation
            - 'vault::'      # Windows Vault

    # Correlation condition - detect the chain pattern
    # Option 1: CRITICAL - Full attack chain (Azure sign-in → Mimikatz execution)
    condition_critical: (step1 and step2 and step3 and step5) and (step6_mimikatz_tools or step6_mimikatz_functions or step6_mimikatz_modules)

    # Option 2: HIGH - Atypical travel + risky behavior → Mimikatz
    condition_high: (step1 and (step2 or step3) and step5) and (step6_mimikatz_tools or step6_mimikatz_functions or step6_mimikatz_modules)

    # Option 3: MEDIUM - Baseline detection (failed attempts + anonymous IP + success)
    condition_medium: step4 and step2 and step5

    # Option 4: HIGH - Any suspicious Azure sign-in followed by Mimikatz (most practical)
    condition_mimikatz_chain: (step1 or step2 or step5) and (step6_mimikatz_tools or step6_mimikatz_functions or step6_mimikatz_modules)

    # Final condition (any of the above patterns)
    condition: condition_critical or condition_high or condition_medium or condition_mimikatz_chain

    # Timeframe for correlation (events must occur within this window)
    # NOTE: Requires SIEM correlation by UserPrincipalName/User account across log sources
    timeframe: 24h

falsepositives:
    - Legitimate business travel with VPN usage
    - Users traveling internationally for work
    - Mobile users with dynamic IP addresses
    - Shared accounts (should be remediated)
    - Third-party authentication apps
    - Authorized penetration testing or red team exercises
    - Security research in isolated lab environments
    - False positives for Mimikatz: strings in legitimate software (very unlikely)
level: critical
tags:
    # Initial Access & Authentication
    - attack.initial_access
    - attack.t1078.004  # Cloud Accounts
    - attack.t1110  # Brute Force
    # Credential Access & Dumping
    - attack.credential_access
    - attack.t1003.001  # LSASS Memory
    - attack.t1003.002  # Security Account Manager
    - attack.t1003.004  # LSA Secrets
    - attack.t1003.005  # Cached Domain Credentials
    - attack.t1003.006  # DCSync
    # Defense Evasion
    - attack.defense_evasion
    - attack.t1090.003  # Proxy/Anonymization
fields:
    # Azure AD Sign-in Fields
    - UserPrincipalName
    - IPAddress
    - Location
    - Country
    - City
    - State
    - RiskEventTypes
    - RiskState
    - RiskLevelDuringSignIn
    - RiskLevelAggregated
    - AuthenticationRequirement
    - ConditionalAccessStatus
    - DeviceDetail.displayName
    - DeviceDetail.operatingSystem
    - DeviceDetail.browser
    - AppDisplayName
    - ResourceDisplayName
    - UserAgent
    - CorrelationId
    - CreatedDateTime
    # Windows Process Creation Fields (Mimikatz detection)
    - User
    - ComputerName
    - CommandLine
    - Image
    - ParentImage
    - ParentCommandLine
    - ProcessId
    - ParentProcessId

# ===== SIEM CORRELATION CONFIGURATION =====
# This rule requires cross-log source correlation. Implementation examples:
#
# Microsoft Sentinel (KQL):
# let SuspiciousSignIns = SigninLogs
#     | where TimeGenerated > ago(24h)
#     | where ResultType == 0
#     | where RiskEventTypes has_any ("impossibleTravel", "anonymousIPAddress")
#     | project SignInTime=TimeGenerated, UserPrincipalName, IPAddress, RiskEventTypes;
# SecurityEvent
#     | where TimeGenerated > ago(24h)
#     | where EventID == 4688
#     | where CommandLine has_any ("mimikatz", "sekurlsa::", "lsadump::")
#     | join kind=inner (SuspiciousSignIns) on $left.TargetUserName == $right.UserPrincipalName
#     | where TimeGenerated between (SignInTime .. (SignInTime + 24h))
#
# Splunk:
# index=azure sourcetype="azure:signinlogs" ResultType=0 (RiskEventTypes=*impossibleTravel* OR RiskEventTypes=*anonymousIPAddress*)
# | join type=inner UserPrincipalName [search index=windows EventCode=4688 (CommandLine=*mimikatz* OR CommandLine=*sekurlsa* OR CommandLine=*lsadump*)]
# | where _time - azure_signin_time < 86400
#
# Elastic SIEM:
# Create a correlation rule joining azure.signinlogs and winlog.event_data.CommandLine
# with user.name as the common field and 24h time window
